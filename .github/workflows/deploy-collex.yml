name: Deploy collex development

on:
  push:
    branches:
      - development   

jobs:
  deploy-dev: 
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SKRYFON_PRIVATE_KEY }}

      - name: Add SSH server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p 2255 46.28.44.166 >> ~/.ssh/known_hosts

      - name: Deploy development branch to /home/repos/skryfon-org/collex
        run: |
          rsync -avz --delete \
            --exclude='.env' \
            --exclude='container/.env' \
            --exclude='container/.env.dev' \
            --exclude='.gitignore' \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='client/.env' \
            --exclude='client/node_modules/' \
            --exclude='client/dist/' \
            --exclude='tmp/' \
            --exclude='build/' \
            --exclude='*.log' \
            -e 'ssh -p 2255' ./ root@46.28.44.166:/home/repos/skryfon-org/collex

      - name: Setup development environment files
        run: |
          ssh -p 2255 root@46.28.44.166 << 'EOF'
            set -e  # Exit immediately if any command fails

            cd /home/repos/skryfon-org/collex

            # Setup development environment file if it doesn't exist
            if [ ! -f container/.env.dev ]; then
              echo "Creating development .env.dev file from example..."
              cp container/env.dev.example container/.env.dev
              echo "Development environment file created. Update if needed."
            fi

            # Ensure container directory permissions
            chmod +x container/scripts/container-manager.sh 2>/dev/null || true
          EOF

      - name: Deploy development containers with Podman
        run: |
          ssh -p 2255 root@46.28.44.166 << 'EOF'
            set -e  # Exit immediately if any command fails

            cd /home/repos/skryfon-org/collex

            # Stop existing development containers gracefully
            echo "Stopping existing development containers..."
            make podman-dev-down || echo "No containers to stop"

            # Build fresh development images with Podman
            echo "Building development Podman images..."
            make podman-dev-build

            # Run database migrations for development
            echo "Running database migrations..."
            make podman-dev-migrate || echo "Migration completed or not needed"

            # Start development containers with Podman
            echo "Starting development containers..."
            make podman-dev

            # Verify deployment
            echo "Verifying deployment..."
            sleep 30
            make podman-dev-status

            echo "Development deployment completed successfully!"
            echo "Backend available at: http://localhost:7072"
            echo "Frontend available at: http://localhost:7073"
            echo "Database available at: http://localhost:5435"
            echo "Health check: http://localhost:7072/health"
          EOF

      - name: Cleanup old images and show status
        run: |
          ssh -p 2255 root@46.28.44.166 << 'EOF'
            cd /home/repos/skryfon-org/collex
            
            # Clean up dangling images to save space
            podman image prune -f || echo "No images to clean"
            
            # Show final development container status
            echo "=== Final Development Container Status ==="
            make podman-dev-status
            
            echo "=== Development Services ==="
            echo "Backend API: http://localhost:7072"
            echo "Frontend: http://localhost:7073"
            echo "Database: localhost:5435"
            echo "Health Check: http://localhost:7072/health"
            
            echo "=== Disk Usage ==="
            df -h | grep -E "(Filesystem|/dev/)"
          EOF
